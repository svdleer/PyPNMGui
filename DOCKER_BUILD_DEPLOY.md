# PyPNM GUI - Docker Build & Deploy Guide

## ğŸ—ï¸ Build & Deploy Workflow

### Step 1: Build Images Locally (on Mac)

```bash
cd /Users/silvester/PythonDev/Git/PyPNMGui

# Build Docker images
./build-and-deploy.sh build
```

This builds:
- `pypnm-gui:latest` - Web GUI server
- `pypnm-gui-agent:latest` - Agent container

### Step 2: Deploy to appdb-sh.oss.local

**Option A: Transfer images and deploy directly**
```bash
./build-and-deploy.sh all
```

This will:
1. Build images
2. Save as tar.gz
3. Transfer via SSH jump server
4. Load on remote server
5. Deploy with docker-compose

**Option B: Use Git deployment (existing script)**
```bash
./deploy-git.sh deploy
```

This pulls latest code on remote server and rebuilds there.

### Step 3: Check Status

```bash
# View status
./build-and-deploy.sh status

# View logs
./build-and-deploy.sh logs
```

## ğŸš€ Quick Commands

```bash
# Just build locally
./build-and-deploy.sh build

# Build and save for transfer
./build-and-deploy.sh save

# Transfer to remote
./build-and-deploy.sh transfer

# Deploy only (after transfer)
./build-and-deploy.sh deploy

# Do everything
./build-and-deploy.sh all

# Check status
./build-and-deploy.sh status

# View logs (live)
./build-and-deploy.sh logs
```

## ğŸ“ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mac (Local Development)                             â”‚
â”‚ /Users/silvester/PythonDev/Git/PyPNMGui             â”‚
â”‚                                                     â”‚
â”‚ 1. Edit code                                        â”‚
â”‚ 2. Build Docker images                              â”‚
â”‚ 3. Test locally (optional)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ SSH via script3a.oss.local
                  â”‚ (jump server)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ appdb-sh.oss.local (Deployment Server)             â”‚
â”‚ /opt/pypnm-gui                                      â”‚
â”‚                                                     â”‚
â”‚ Docker Containers:                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ pypnm-gui (GUI Server)                      â”‚     â”‚
â”‚ â”‚ - Flask web app                             â”‚     â”‚
â”‚ â”‚ - WebSocket endpoint /ws/agent              â”‚     â”‚
â”‚ â”‚ - Port 5050                                 â”‚     â”‚
â”‚ â”‚ - Connects to appdb.oss.local for CMTS      â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                     â”‚
â”‚ Agent (runs separately, not in Docker)              â”‚
â”‚ - /opt/pypnm-agent/                                 â”‚
â”‚ - Connects to GUI WebSocket                         â”‚
â”‚ - Has network access to CMTS/modems                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Configuration

### On appdb-sh.oss.local

Environment file: `/opt/pypnm-gui/docker/.env`

```bash
# Auto-generated by build-and-deploy.sh
SECRET_KEY=<random-generated>
AGENT_AUTH_TOKEN=<random-generated>
FLASK_ENV=production
LOG_LEVEL=INFO
APPDB_API_URL=https://appdb.oss.local/isw/api
APPDB_API_USER=isw
APPDB_API_PASS=Spyem_OtGheb4
ENABLE_AGENT_WEBSOCKET=true
DATA_MODE=agent
```

## ğŸ› Troubleshooting

### Build fails on Mac
```bash
# Check Docker is running
docker ps

# Clean and rebuild
docker system prune -a
./build-and-deploy.sh build
```

### Transfer fails
```bash
# Test SSH jump connection
ssh -i ~/.ssh/id_rsa svdleer@script3a.oss.local "echo Connected"

# Test final SSH connection
ssh -i ~/.ssh/id_rsa \
  -o ProxyCommand="ssh -i ~/.ssh/id_rsa -W localhost:2222 svdleer@script3a.oss.local" \
  svdleer@localhost "echo Connected"
```

### Container won't start
```bash
# SSH to remote and check
ssh -i ~/.ssh/id_rsa \
  -o ProxyCommand="ssh -i ~/.ssh/id_rsa -W localhost:2222 svdleer@script3a.oss.local" \
  svdleer@localhost

# On remote server
cd /opt/pypnm-gui/docker
docker-compose logs
docker-compose ps
```

### Agent not connecting
```bash
# On appdb-sh.oss.local
# Check if GUI container is running
docker ps | grep pypnm-gui

# Check GUI logs
cd /opt/pypnm-gui/docker
docker-compose logs -f gui-server | grep -i agent

# Check agent on jump server (if running separately)
ssh script3a.oss.local
cd /opt/pypnm-agent
./status.sh
```

## ğŸ“Š Monitoring

### Health Check
```bash
# From Mac (via tunnel)
curl http://localhost:5050/api/health

# Or SSH to server
ssh -i ~/.ssh/id_rsa \
  -o ProxyCommand="ssh -i ~/.ssh/id_rsa -W localhost:2222 svdleer@script3a.oss.local" \
  svdleer@localhost \
  "curl -s http://localhost:5050/api/health | python3 -m json.tool"
```

### Agent Status
```bash
curl http://localhost:5050/api/agents
```

### CMTS Data
```bash
curl http://localhost:5050/api/cmts | python3 -m json.tool
```

## ğŸ”„ Development Workflow

1. **Edit code locally** on Mac
2. **Build images**: `./build-and-deploy.sh build`
3. **Test locally** (optional): `docker-compose -f docker/docker-compose.yml up`
4. **Deploy to server**: `./build-and-deploy.sh all`
5. **Check status**: `./build-and-deploy.sh status`
6. **View logs**: `./build-and-deploy.sh logs`

## ğŸ“ Notes

- **Images are built on Mac** - M1/M2 compatible, but buildx can create multi-arch
- **Transferred via SSH** - Through jump server
- **Deployed with docker-compose** - On appdb-sh.oss.local
- **Agent runs separately** - Usually not in Docker, runs directly on jump server
- **CMTS data from AppDB** - GUI connects to https://appdb.oss.local

## ğŸ¯ Next Steps

After deployment:
1. Access GUI: http://appdb-sh.oss.local:5050 (or via tunnel)
2. Deploy agent on jump server with network access
3. Configure agent to connect to GUI WebSocket
4. Test modem queries through agent
